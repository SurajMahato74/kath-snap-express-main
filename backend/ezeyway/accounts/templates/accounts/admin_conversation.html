{% extends 'accounts/superadmin_base.html' %}

{% block title %}Chat with {{ other_participant.username }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 85vh;
        display: flex;
        flex-direction: column;
    }
    .chat-header {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        border-radius: 8px 8px 0 0;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
    }
    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-end;
    }
    .message.sent {
        justify-content: flex-end;
    }
    .message.received {
        justify-content: flex-start;
    }
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
    }
    .message.sent .message-bubble {
        background: #007bff;
        color: white;
        border-bottom-right-radius: 4px;
    }
    .message.received .message-bubble {
        background: white;
        color: #333;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 5px;
    }
    .message-status {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 2px;
    }
    .chat-input {
        padding: 15px;
        background: white;
        border-top: 1px solid #dee2e6;
        border-radius: 0 0 8px 8px;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(45deg, #007bff, #0056b3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    .profile-info {
        cursor: pointer;
    }
    .profile-info:hover {
        background-color: #e9ecef;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}


<!-- Chat Container -->
<div class="card">
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <a href="{% url 'admin_messages' %}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div class="d-flex align-items-center profile-info flex-grow-1" onclick="window.location.href='{% url 'user_profile_details' other_participant.id %}'">
                    <div class="user-avatar me-3">
                        {{ other_participant.username|first|upper }}
                    </div>
                    <div>
                        <h6 class="mb-0">{{ other_participant.username }}</h6>
                        <small class="text-muted">
                            <span class="badge bg-{% if other_participant.user_type == 'customer' %}primary{% elif other_participant.user_type == 'vendor' %}warning{% else %}secondary{% endif %}">
                                {{ other_participant.get_user_type_display }}
                            </span>
                            {% if other_participant.email %}
                                • {{ other_participant.email }}
                            {% endif %}
                            {% if other_participant.phone_number %}
                                • {{ other_participant.phone_number }}
                            {% endif %}
                        </small>
                    </div>
                    <div class="ms-auto">
                        <small class="text-muted">Click to view profile & transactions</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
                <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                    <div class="message-bubble">
                        <div>{{ message.content }}</div>
                        <div class="message-time">
                            {{ message.created_at|date:"M d, H:i" }}
                        </div>
                        {% if message.sender == request.user %}
                            <div class="message-status">
                                {% if message.status == 'sent' %}
                                    <i class="fas fa-check"></i>
                                {% elif message.status == 'delivered' %}
                                    <i class="fas fa-check-double"></i>
                                {% elif message.status == 'read' %}
                                    <i class="fas fa-check-double text-primary"></i>
                                {% endif %}
                                {{ message.get_status_display }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-4">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No messages yet</h5>
                    <p class="text-muted">Start the conversation by sending a message below.</p>
                </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="chat-input">
            <form method="post" class="d-flex">
                {% csrf_token %}
                <input type="text" name="content" class="form-control me-2" placeholder="Type your message..." required autocomplete="off">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>



{% endblock %}

{% block extra_js %}
<script>
// Web Audio API notification system (same as React app)

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

function playNotificationSound() {
    // Use same Web Audio API system as React app
    createBeepSound();
}

function createBeepSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create a triple beep notification sound - same as React
        playBeep(audioContext, 800, 0.3, 0.4); // First beep
        setTimeout(() => playBeep(audioContext, 1000, 0.3, 0.4), 400); // Second beep
        setTimeout(() => playBeep(audioContext, 1200, 0.4, 0.5), 800); // Third beep
    } catch (error) {
        console.warn('Web Audio API not supported:', error);
    }
}

function playBeep(audioContext, frequency, duration, volume) {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'square'; // Square wave is more noticeable
    
    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
}

function showBrowserNotification(senderName, message) {
    if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(`New message from ${senderName}`, {
            body: message.length > 50 ? message.substring(0, 50) + '...' : message,
            icon: '/static/logo.png',
            tag: 'admin-message',
            requireInteraction: true
        });
        
        notification.onclick = function() {
            window.focus();
            notification.close();
        };
        
        setTimeout(() => notification.close(), 10000);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Auto-scroll to bottom
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Focus on input
    const messageInput = document.querySelector('input[name="content"]');
    messageInput.focus();
    
    // Auto-refresh messages every 5 seconds
    let lastMessageCount = document.querySelectorAll('.message').length;
    
    setInterval(function() {
        fetch(window.location.href + '?ajax=1&last_count=' + lastMessageCount, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.new_messages && data.new_messages.length > 0) {
                const chatMessages = document.getElementById('chatMessages');
                const isScrolledToBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 1;
                
                data.new_messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.is_sent ? 'sent' : 'received'}`;
                    messageDiv.innerHTML = `
                        <div class="message-bubble">
                            <div>${message.content}</div>
                            <div class="message-time">${message.created_at}</div>
                            ${message.is_sent ? `<div class="message-status">${message.status_icon} ${message.status_display}</div>` : ''}
                        </div>
                    `;
                    chatMessages.appendChild(messageDiv);
                    
                    // Show notification for received messages
                    if (!message.is_sent) {
                        playNotificationSound();
                        showBrowserNotification('{{ other_participant.username }}', message.content);
                    }
                });
                
                // Broadcast to React app via postMessage
                if (data.new_messages.length > 0) {
                    try {
                        // Try to communicate with React app
                        const reactWindow = window.open('', 'react-app');
                        if (reactWindow) {
                            reactWindow.postMessage({
                                type: 'NEW_MESSAGE',
                                sender: '{{ other_participant.username }}',
                                content: data.new_messages[0].content,
                                conversationId: {{ conversation.id }}
                            }, 'http://localhost:8080');
                        }
                    } catch (e) {
                        console.log('Could not communicate with React app');
                    }
                }
                
                if (isScrolledToBottom) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                lastMessageCount += data.new_messages.length;
            }
        })
        .catch(error => {
            console.error('Error fetching new messages:', error);
        });
    }, 5000);
});

function sendQuickMessage(message) {
    const messageInput = document.querySelector('input[name="content"]');
    messageInput.value = message;
    messageInput.focus();
}

// Handle Enter key and broadcast message
document.querySelector('input[name="content"]').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const content = this.value;
        if (content.trim()) {
            // Broadcast to other domains
            broadcastMessage('{{ request.user.username }}', content, {{ conversation.id }});
            playNotificationSound();
        }
        this.closest('form').submit();
    }
});

// Play sound when send button is clicked
document.querySelector('button[type="submit"]').addEventListener('click', function() {
    const content = document.querySelector('input[name="content"]').value;
    if (content.trim()) {
        broadcastMessage('{{ request.user.username }}', content, {{ conversation.id }});
        playNotificationSound();
    }
});

// Broadcast message function
function broadcastMessage(sender, content, conversationId) {
    fetch('/api/broadcast/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            sender: sender,
            content: content,
            conversation_id: conversationId
        })
    }).catch(e => console.log('Broadcast failed:', e));
}

// Poll for broadcasts from other domains
let lastBroadcastCheck = Date.now() / 1000;
setInterval(function() {
    fetch(`/api/broadcast/?conversation_id={{ conversation.id }}&since=${lastBroadcastCheck}`)
        .then(response => response.json())
        .then(data => {
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    if (msg.sender !== '{{ request.user.username }}') {
                        playNotificationSound();
                        showBrowserNotification(msg.sender, msg.content);
                    }
                });
                lastBroadcastCheck = Date.now() / 1000;
            }
        })
        .catch(e => console.log('Broadcast check failed:', e));
}, 2000);
</script>
{% endblock %}